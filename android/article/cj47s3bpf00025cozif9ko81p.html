<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Android，博客，码农，小阿飞，码农小阿飞" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="前言随着一款APP应用功能的不断完善，用户群体的不断增多，APP的更新也就不仅仅局限于功能需求，如何做好良好的用户体验，让用户传播良好的体验口碑，显得尤为重要，而用户体验一块日夜间模式俨然成为了标配。其实，日夜间功能就是换肤的一种，关于换肤功能的实现，也是众说纷纭，总的来讲分为两类：主题换肤（Theme）和插件换肤（APK换肤）。 插件换肤 插件换肤的实现原理就是主APK根据当前环境需求，解析">
<meta property="og:type" content="article">
<meta property="og:title" content="Android主题切换（Theme）实现日夜间功能">
<meta property="og:url" content="http://yoursite.com/android/article/cj47s3bpf00025cozif9ko81p.html">
<meta property="og:site_name" content="码农小阿飞的博客">
<meta property="og:description" content="前言随着一款APP应用功能的不断完善，用户群体的不断增多，APP的更新也就不仅仅局限于功能需求，如何做好良好的用户体验，让用户传播良好的体验口碑，显得尤为重要，而用户体验一块日夜间模式俨然成为了标配。其实，日夜间功能就是换肤的一种，关于换肤功能的实现，也是众说纷纭，总的来讲分为两类：主题换肤（Theme）和插件换肤（APK换肤）。 插件换肤 插件换肤的实现原理就是主APK根据当前环境需求，解析">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/430632-49ce383d76352277.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/640">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/430632-72c32a8d719947be.gif?imageMogr2/auto-orient/strip">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/430632-ba400e9da3e427de.gif?imageMogr2/auto-orient/strip">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/430632-d77b38c490564f31.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/640">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/430632-cc5d5a6a03505f02.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/640">
<meta property="og:updated_time" content="2017-06-21T08:28:16.652Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android主题切换（Theme）实现日夜间功能">
<meta name="twitter:description" content="前言随着一款APP应用功能的不断完善，用户群体的不断增多，APP的更新也就不仅仅局限于功能需求，如何做好良好的用户体验，让用户传播良好的体验口碑，显得尤为重要，而用户体验一块日夜间模式俨然成为了标配。其实，日夜间功能就是换肤的一种，关于换肤功能的实现，也是众说纷纭，总的来讲分为两类：主题换肤（Theme）和插件换肤（APK换肤）。 插件换肤 插件换肤的实现原理就是主APK根据当前环境需求，解析">
<meta name="twitter:image" content="http://upload-images.jianshu.io/upload_images/430632-49ce383d76352277.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/640">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/android/article/cj47s3bpf00025cozif9ko81p.html"/>





  <title>Android主题切换（Theme）实现日夜间功能 | 码农小阿飞的博客</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?dadda70e9b159ddf7427ab3beb6ac6dc";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">码农小阿飞的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-bars"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/android/article/cj47s3bpf00025cozif9ko81p.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CoderMario">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="码农小阿飞的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Android主题切换（Theme）实现日夜间功能</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-06T17:15:48+08:00">
                2017-03-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/android/article/cj47s3bpf00025cozif9ko81p.html" class="leancloud_visitors" data-flag-title="Android主题切换（Theme）实现日夜间功能">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="http://upload-images.jianshu.io/upload_images/430632-49ce383d76352277.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p>
<p><br></p>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>随着一款APP应用功能的不断完善，用户群体的不断增多，APP的更新也就不仅仅局限于功能需求，如何做好良好的用户体验，让用户传播良好的体验口碑，显得尤为重要，而用户体验一块日夜间模式俨然成为了标配。其实，日夜间功能就是换肤的一种，关于换肤功能的实现，也是众说纷纭，总的来讲分为两类：主题换肤（Theme）和插件换肤（APK换肤）。<br><br></p>
<p><code>插件换肤</code> 插件换肤的实现原理就是主APK根据当前环境需求，解析指定目录下对应的插件APK，获得其中同名的资源文件并动态替换到主APK的应用程序中。插件APK并不需要安装，只需要放置在指定目录下即可。</p>
<ul>
<li>优点： 能够实现各种主题样式的加载，比较灵活，需要增添新的主题只要新建一个插件APK，并配置好相关的资源，放置到指定的文件目录下就行，很方便。</li>
<li>缺点： 需要对控件进行适配修改，实现换肤功能，对于自定义控件，也需要在适配上花点时间。而且放置在文件夹中的插件APK也可能会因为被误删或是损坏而造成资源获取不到，导致换肤失败。<br><br></li>
</ul>
<p><code>主题换肤</code> 主题换肤的实现原理就是在主apk配置多套主题，每套主题对同一个属性使用相应的资源。</p>
<ul>
<li>优点： 相比插件换肤来说更容易上手，理解起来也会更容易。</li>
<li>缺点： 增添新的主题样式必须要发布新版本。全部资源文件都放在APK中，APK会显得十分臃肿，特别是图片资源，因此个人推荐纯色线条的图标，并通过着色来实现不同主题下换肤的可能。</li>
</ul>
<p><br></p>
<p>因为今天的主题是日夜间模式，考虑到并不会涉及主题样式增添的可能，所以权衡之下还是选择使用主题换肤来实现日夜间模式，老套路，效果预览（文末将附上高清地址入口）</p>
<p><img src="http://upload-images.jianshu.io/upload_images/430632-72c32a8d719947be.gif?imageMogr2/auto-orient/strip" alt="预览效果第一季枪版"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/430632-ba400e9da3e427de.gif?imageMogr2/auto-orient/strip" alt="预览效果第二季枪版"></p>
<p><br><br><br></p>
<h3 id="准备相关的属性样式及主题："><a href="#准备相关的属性样式及主题：" class="headerlink" title="准备相关的属性样式及主题："></a>准备相关的属性样式及主题：</h3><h4 id="自定义attr属性："><a href="#自定义attr属性：" class="headerlink" title="自定义attr属性："></a>自定义attr属性：</h4><p>主题换肤和插件换肤原理其实一样，就是控制不同模式下加载对应的资源文件，只是实现的方式不同而已。以往我们在写xml布局文件的时候，默认的属性赋值都是绝对的，即<code>android:background=&quot;#FFFFFF&quot;</code>或<code>android:background=&quot;@color/white&quot;</code>。<br>而一旦属性被这样赋值，默认的资源加载就被限制，倘若有需求需要视图在加载时能够根据当前环境配置特定的资源，那就只能在Java程序代码中动态修改，繁琐程度可想而知。那么是否一个办法能够使xml属性的赋值能够动态的根据当前主题样式的改变而去加载默认的资源呢 ?<br>有，那就是今天的腕儿：自定义属性。在我看来自定义属性在主题换肤中充当着占位符的角色，它会告诉系统这是一个相对的引用，真正的资源引用是当前上下文环境所对应的主题样式属性列表中，对这个自定义属性的赋值。</p>
<p>1.在res-value目录下新建attr属性的资源文件，例如：<code>custom_theme_attrs.xml</code>。<br>2.在<code>custom_theme_attrs.xml</code>文件中新建自定义属性。</p>
<p>格式：</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;resources&gt;
    &lt;attr name=&quot;自定义属性名称&quot; format=&quot;资源引用格式(color、dimen、reference...)&quot; /&gt;
&lt;/resources&gt;
</code></pre><p>示例：</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;resources&gt;
    &lt;!-- 控制app背景色 format:颜色值、资源引用 --&gt;
    &lt;attr name=&quot;custom_attr_app_bg&quot; format=&quot;color|reference&quot; /&gt;
    &lt;!-- 控制app标题栏背景色 format:颜色值、资源引用 --&gt;
    &lt;attr name=&quot;custom_attr_app_title_layout_bg&quot; format=&quot;color|reference&quot; /&gt;
    &lt;!-- 用户头像显示占位Drawable format:颜色值、资源引用 --&gt;
    &lt;attr name=&quot;custom_attr_user_photo_place_holder&quot; format=&quot;color|reference&quot; /&gt;
    &lt;!-- 用户昵称字体颜色 format:颜色值、资源引用 --&gt;
    &lt;attr name=&quot;custom_attr_nickname_text_color&quot; format=&quot;color|reference&quot; /&gt;
    &lt;!-- 用户备注字体颜色 format:颜色值、资源引用 --&gt;
    &lt;attr name=&quot;custom_attr_remark_text_color&quot; format=&quot;color|reference&quot; /&gt;
    &lt;!-- 用户头像显示的透明度 format:尺寸值、资源引用 --&gt;
    &lt;attr name=&quot;custom_attr_user_photo_alpha&quot; format=&quot;dimension|reference&quot; /&gt;
&lt;/resources&gt;
</code></pre><p>写过自定义View的朋友一定不会陌生，不就是自定义属性嘛。区别就是这些属性值没有包裹在<code>styleable</code>中，至于为啥我就不班门弄斧，有需要的朋友可以了解简书作者<a href="http://www.jianshu.com/u/a79bd8f1db7c" target="_blank" rel="external">楚云之南</a>写的<a href="http://www.jianshu.com/p/61b79e7f88fc" target="_blank" rel="external">《深入理解Android 自定义attr Style styleable以及其应用》</a>，感觉写的不错，感谢分享 ！！<br><br></p>
<h4 id="自定义theme主题："><a href="#自定义theme主题：" class="headerlink" title="自定义theme主题："></a>自定义theme主题：</h4><p>Style想必并不陌生，在需要写很多类似的代码块时，我们通常会提取其中共有部分，配置在Style中，直接在xml中的style属性中引用即可，非常方便。这里所说的主题其实也是Style样式中的一种，只是它不仅仅局限于控件样式属性的赋值，常常还涉及到window窗口相关，就是样式属性的一个集合。既然是通过切换主题来切换应用UI样式，所以在定义Style主题样式的时候，需要准备多套主题样式。</p>
<p>1.在res-value目录下新建style属性的资源文件，例如：<code>custom_theme_styles.xml</code>。<br>2.在<code>custom_theme_styles.xml</code>文件中新建自定义主题，并对特定的系统、自定义属性进行赋值操作。</p>
<p>格式：</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;resources&gt;
    &lt;style name=&quot;自定义主题样式的名称&quot; parent=&quot;继承的主题，可以是自定义主题样式也可以是系统主题样式&quot;&gt;
        &lt;item name=&quot;属性名称&quot;&gt;赋值的对应资源&lt;/item&gt;
    &lt;/style&gt;
&lt;/resources&gt;
</code></pre><p>示例：</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;resources&gt;
    &lt;style name=&quot;MarioTheme&quot; parent=&quot;Theme.AppCompat.Light.DarkActionBar&quot; &gt;
        &lt;!-- 隐藏Activity窗口的ActionBar --&gt;
        &lt;item name=&quot;windowActionBar&quot;&gt;false&lt;/item&gt;
        &lt;!-- 隐藏Activity窗口的Title标题栏 --&gt;
        &lt;item name=&quot;windowNoTitle&quot;&gt;true&lt;/item&gt;
    &lt;/style&gt;

    &lt;style name=&quot;MarioTheme.Day&quot; &gt;
        &lt;!-- 日间模式下 &quot;custom_attr_app_bg&quot; 的赋值为#FFFFFF --&gt;
        &lt;item name=&quot;custom_attr_app_bg&quot;&gt;#FFFFFF&lt;/item&gt;
        ...
    &lt;/style&gt;

    &lt;style name=&quot;MarioTheme.Night&quot; &gt;
        &lt;!-- 夜间模式下 &quot;custom_attr_app_bg&quot; 的赋值为#1F1F1F --&gt;
        &lt;item name=&quot;custom_attr_app_bg&quot;&gt;#1F1F1F&lt;/item&gt;
        ...
    &lt;/style&gt;
&lt;/resources&gt;
</code></pre><p>如上述示例所示，首先是新建一个继承自系统<code>Theme.AppCompat.Light.DarkActionBar</code>样式的自定义主题<code>MarioTheme</code>算是一个主题的Base基础主题，在这个基础主题中，可以对一些通用的属性进行赋值，比如一些全局性的窗口样式，当然这些赋值上去的属性也是可以被后来继承的子类主题覆盖。<br>然后又新建了两个继承自这个基础主题的<code>MarioTheme.Day</code>和<code>MarioTheme.Night</code>分别作为日间和夜间的主题，而且分别在两个主题中对自定义属性<code>custom_attr_app_bg</code>进行了赋值。</p>
<p>其实通过上述两个步骤：[自定义属性 –&gt; 自定义主题，并在主题中对自定义属性进行相应的赋值]，主题换肤的准备工作可以说是已经完成。但是为了项目的可维护性更高，尚且有不少可以优化的地方，如上<code>#1F1F1F</code>颜色值直接出现在style中。这是我非常反对的一种操作方式，在使用主题换肤的应用中，随着应用功能的强大，自定义属性的数量一定会越来越多，而且我觉得自定义属性定义的越精细越好，所以一定会有一个庞大数量的属性列表需要去维护。其中也有可能大部分是可以被重复使用的，何不将它们整理到统一的文件中，倘若到时候需求变化，资源引用需要修改，也不至于全局搜索挨个去改，何必给自己增加这么多没有必要的工作量呢 ！  所以我还要讲讲自定义属性 。</p>
<p><br><br><br></p>
<h4 id="自定义resource资源："><a href="#自定义resource资源：" class="headerlink" title="自定义resource资源："></a>自定义resource资源：</h4><p>同类型的资源新建在对应的目录下，尺寸资源定义在<code>values-dimens</code>目录下，颜色资源定义再<code>values-colors</code>目录下，drawable资源定义在<code>values</code>目录下对应的drawable目录下…  并且每一种资源都应该根据不同主题样式配置多套。</p>
<p><br></p>
<h5 id="自定义color："><a href="#自定义color：" class="headerlink" title="自定义color："></a>自定义color：</h5><p>1.在res-value目录下新建color属性的资源文件，例如：<code>custom_theme_colors.xml</code>。<br>2.在<code>custom_theme_colors.xml</code>文件中新建自定义color颜色。</p>
<p>格式：</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;resources&gt;
    &lt;color name=&quot;自定义color名称_day&quot;&gt;对应的日间颜色值&lt;/color&gt;
    &lt;color name=&quot;自定义color名称_night&quot;&gt;对应的夜间颜色值&lt;/color&gt;
&lt;/resources&gt;
</code></pre><p>定义app背景色为例：</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;resources&gt;
    &lt;!-- 日间模式下app背景色 --&gt;
    &lt;color name=&quot;custom_color_app_bg_day&quot;&gt;#FFFFFF&lt;/color&gt;
    &lt;!-- 日间模式下app标题栏背景色 --&gt;
    &lt;color name=&quot;custom_color_app_title_layout_bg_day&quot;&gt;#FF2F3A4C&lt;/color&gt;        
    &lt;!-- 夜间模式下app背景色 --&gt;
    &lt;color name=&quot;custom_color_app_bg_night&quot;&gt;#1F1F1F&lt;/color&gt;
    &lt;!-- 夜间模式下app标题栏背景色 --&gt;  
    &lt;color name=&quot;custom_color_app_title_layout_bg_night&quot;&gt;#FF1D1D1D&lt;/color&gt; 
    ... 
&lt;/resources&gt;
</code></pre><p><br></p>
<h5 id="自定义drawable："><a href="#自定义drawable：" class="headerlink" title="自定义drawable："></a>自定义drawable：</h5><p>1.在res目录下新建<code>drawable</code>文件夹。<br>1.在<code>res-drawable</code>目录下新建drawable资源文件。</p>
<p>定义圆形图片的占位drawable，示例：</p>
<p><code>custom_drawable_user_photo_place_holder_day.xml</code></p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;shape xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;
    &lt;solid android:color=&quot;@color/custom_color_user_photo_place_holder_bg_day&quot; /&gt;
    &lt;corners android:radius=&quot;32dp&quot; /&gt;
&lt;/shape&gt;
</code></pre><p><code>custom_drawable_user_photo_place_holder_night.xml</code></p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;shape xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;
    &lt;solid android:color=&quot;@color/custom_color_user_photo_place_holder_bg_night&quot; /&gt;
    &lt;corners android:radius=&quot;32dp&quot; /&gt;
&lt;/shape&gt;
</code></pre><p>自定义drawable中使用到的颜色值推荐也统一整理到<code>custom_theme_colors.xml</code>文件中。</p>
<pre><code>&lt;!-- 用户头像占位drawable背景颜色 --&gt;
&lt;color name=&quot;custom_color_user_photo_place_holder_bg_day&quot;&gt;#29303B&lt;/color&gt;
&lt;color name=&quot;custom_color_user_photo_place_holder_bg_night&quot;&gt;#171717&lt;/color&gt;
</code></pre><p><br></p>
<h5 id="自定义colorStateList："><a href="#自定义colorStateList：" class="headerlink" title="自定义colorStateList："></a>自定义colorStateList：</h5><p>同SelectorDrawable一样，color也可以设置Selector选择器。<br>1.value目录下新建<code>color.xml</code>文件。<br>2.在<code>res-color.xml</code>目录下新建color资源文件。</p>
<p>示例：</p>
<p><code>custom_selector_text_day.xml</code></p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;selector xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;
    &lt;item android:color=&quot;@color/custom_color_text_pressed_day&quot; android:state_pressed=&quot;true&quot; /&gt;
    &lt;item android:color=&quot;@color/custom_color_text_day&quot; /&gt;
&lt;/selector&gt;
</code></pre><p><code>custom_selector_text_night.xml</code></p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;selector xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;
    &lt;item android:color=&quot;@color/custom_color_text_pressed_night&quot; android:state_pressed=&quot;true&quot; /&gt;
    &lt;item android:color=&quot;@color/custom_color_text_night&quot; /&gt;
&lt;/selector&gt;
</code></pre><p>同理，自定义colorStateList中使用到的颜色值推荐也统一整理到<code>custom_theme_colors.xml</code>文件中。</p>
<p><br></p>
<h4 id="在不同的主题样式下为自定义属性赋值："><a href="#在不同的主题样式下为自定义属性赋值：" class="headerlink" title="在不同的主题样式下为自定义属性赋值："></a>在不同的主题样式下为自定义属性赋值：</h4><p>示例：</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;resources&gt;
    // 日间相关属性集
    &lt;style name=&quot;MarioTheme.Day&quot; &gt;
        &lt;item name=&quot;custom_attr_app_bg&quot;&gt;@color/custom_color_app_bg_day&lt;/item&gt;
        &lt;item name=&quot;custom_attr_app_title_layout_bg&quot;&gt;@color/custom_color_app_title_layout_bg_day&lt;/item&gt;
        &lt;item name=&quot;custom_attr_user_photo_place_holder&quot;&gt;@drawable/custom_drawable_user_photo_place_holder_day&lt;/item&gt;
    &lt;/style&gt;
    // 夜间相关属性集
    &lt;style name=&quot;MarioTheme.Night&quot; &gt;
        &lt;item name=&quot;custom_attr_app_bg&quot;&gt;@color/custom_color_app_bg_night&lt;/item&gt;
        &lt;item name=&quot;custom_attr_app_title_layout_bg&quot;&gt;@color/custom_color_app_title_layout_bg_night&lt;/item&gt;
        &lt;item name=&quot;custom_attr_user_photo_place_holder&quot;&gt;@drawable/custom_drawable_user_photo_place_holder_night&lt;/item&gt;
    &lt;/style&gt;
&lt;/resources&gt;
</code></pre><p>到这里就完成了相关的准备工作。因为在日夜间模式切换中基本不太会涉及字符串、尺寸的资源样式的修改，实现的方式是一样的，因此不做过多的赘述，有需要的朋友可以自定义去尝试。</p>
<p><br><br><br><br><br></p>
<h4 id="在XML布局文件中使用自定义属性："><a href="#在XML布局文件中使用自定义属性：" class="headerlink" title="在XML布局文件中使用自定义属性："></a>在XML布局文件中使用自定义属性：</h4><p>只要前期准备工作做好了使用起来其实是非常简单的，就是在属性赋值的时候不再使用绝对的资源引用，而是引用已经完成赋值的自定义的属性：</p>
<pre><code>android:需要修改的属性=&quot;?attr/自定义属性名称&quot; 
</code></pre><p>这样的话只要设置自定义属性的View控件的Context上下文环境设置了对应的Theme主题样式，且对我们的自定义样式进行了相应的赋值，则样式的使用就会奏效，切记，项目中使用到的属性一定要在使用的主题样式下赋值，否则应用运行的时候会报错。当然为了更好的开发体验，我们可以在预览模式下设置对应的主题预览我们设置的样式效果是否起效，效果怎么样。 ☟</p>
<p>Demo部分布局代码展示，示例：</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
    xmlns:tools=&quot;http://schemas.android.com/tools&quot;
    android:background=&quot;?attr/custom_attr_app_bg&quot;
    android:layout_height=&quot;match_parent&quot;
    android:layout_width=&quot;match_parent&quot;
    android:orientation=&quot;vertical&quot;&gt;

    &lt;View
        android:background=&quot;?attr/custom_attr_app_title_layout_bg&quot;
        android:id=&quot;@id/custom_id_title_status_bar&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;0dp&quot; /&gt;

    &lt;RelativeLayout
        android:background=&quot;?attr/custom_attr_app_title_layout_bg&quot;
        android:id=&quot;@id/custom_id_title_layout&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;136dp&quot;
        android:paddingBottom=&quot;16dp&quot;
        android:paddingRight=&quot;12dp&quot;
        android:paddingLeft=&quot;12dp&quot;
        android:paddingTop=&quot;8dp&quot; &gt;

        &lt;ImageView
            android:padding=&quot;3dp&quot;
            android:layout_width=&quot;72dp&quot;
            android:layout_height=&quot;72dp&quot;
            android:id=&quot;@+id/theme_user_photo&quot;
            android:layout_alignParentLeft=&quot;true&quot;
            android:layout_alignParentBottom=&quot;true&quot;
            android:alpha=&quot;?attr/custom_attr_user_photo_alpha&quot;
            tools:src=&quot;?attr/custom_attr_user_photo_place_holder&quot; /&gt;

        &lt;LinearLayout
            android:layout_toRightOf=&quot;@+id/theme_user_photo&quot;
            android:layout_alignTop=&quot;@+id/theme_user_photo&quot;
            android:layout_width=&quot;wrap_content&quot;
            android:gravity=&quot;center_vertical&quot;
            android:layout_marginLeft=&quot;12dp&quot;
            android:orientation=&quot;vertical&quot;
            android:layout_height=&quot;72dp&quot; &gt;

            &lt;TextView
                android:textColor=&quot;?attr/custom_attr_nickname_text_color&quot;
                android:layout_height=&quot;wrap_content&quot;
                android:layout_width=&quot;wrap_content&quot;
                android:id=&quot;@+id/theme_nickname&quot;
                android:text=&quot;@string/nickname&quot;
                android:textSize=&quot;19dp&quot; /&gt;

            &lt;TextView
                android:textColor=&quot;?attr/custom_attr_remark_text_color&quot;
                android:text=&quot;@string/remark&quot;
                android:layout_height=&quot;wrap_content&quot;
                android:layout_width=&quot;wrap_content&quot;
                android:layout_marginTop=&quot;3dp&quot;
                android:id=&quot;@+id/theme_remark&quot;
                android:textSize=&quot;12dp&quot; /&gt;
        &lt;/LinearLayout&gt;
    &lt;/RelativeLayout&gt;
&lt;/LinearLayout&gt;
</code></pre><p><img src="http://upload-images.jianshu.io/upload_images/430632-d77b38c490564f31.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt="日间预览"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/430632-cc5d5a6a03505f02.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt="夜间预览"></p>
<p> 预览中的两个主题<code>MarioTheme.Day.Preview</code>和<code>MarioTheme.Night.Preview</code>分别继承之<code>MarioTheme.Day</code>和<code>MarioTheme.Night</code>，并没有在项目中使用起来，主要用来控制状态栏的颜色，个人用于编辑器状态栏沉浸效果的一个预览效果。</p>
<p>到这一步，在Activity中使用<code>setTheme()</code>就能加载对应主题的视图啦 ！！  有没有很赞 ？<br>需要注意的一点是 <code>setTheme()</code>方法必须要在系统调用<code>setContentView()</code>方法前调用，个人推荐统一写到基类BaseActivity的<code>onCreate()</code>方法中。而我们需要做的就是在本地SharePreference中配置一个tag控制BaseActivity设置不同的主题就行啦 ！<br>也许看到这里你已经跃跃欲试，或者你已经一步一步照着写到这里，但是应用跑起来却发现，在Activity中点击按钮调用<code>setTheme()</code>方法，Activity并不会发生变化，或者返回上一个Activity也是没有变化。并不是<code>setTheme()</code>方法没有奏效，<code>setTheme()</code>方法确实起到应有的效果了（可以调用getTheme()方法查看，当前主题确实已经改变）。那又是什么原因呢？ 那是因为这些视图都是已经加载完成，设置主题并不会触发系统去刷新UI，因此需要我们手动去触发。</p>
<p>而更改主题后的UI刷新我推荐两种：</p>
<ul>
<li><code>重新创建Activity</code>  关于重新创建Activity，只需要调用Activity的<code>recreate()</code>方法就行，普通不复杂的UI，用这个方法基本可以满足，其中主要涉<code>onSaveInstanceState()</code>应用状态的保存，而使用这种方法重新创建Activity也是Google官方比较推崇的，有兴趣可以<a href="https://developer.android.com/training/basics/activity-lifecycle/recreating.html?hl=zh-cn" target="_blank" rel="external">了解一下</a>。</li>
<li><code>手动加载当前主题下的应用资源</code> 这是我这里需要重点讲一下的。由于UI的复杂性和特殊性，并不是所有应用的Activity都可以通过<code>onSaveInstanceState()</code>来保存当前的应用状态的，因此了解如何从当前主题获取需要的属性资源显得尤为重要。</li>
</ul>
<p><br></p>
<h3 id="获得当前主题自定义属性指定的资源："><a href="#获得当前主题自定义属性指定的资源：" class="headerlink" title="获得当前主题自定义属性指定的资源："></a>获得当前主题自定义属性指定的资源：</h3><p>其实获取这个资源也很简单，也就两步：<br><br></p>
<ul>
<li><p><code>Step-01  获取TypedValue</code>                                                                                      </p>
<pre><code>TypedValue typedValue = new TypedValue(); 
Resources.Theme theme = getTheme(); 
try {
    theme.resolveAttribute(R.attr.自定义属性, typedValue, true);
} catch (Exception e) {
    e.printStackTrace();
}
</code></pre></li>
</ul>
<p>首先定义一个TypedValue用于承载Resource资源属性，然后获取当前上下文对应的Theme主题，再是通过<code>resolveAttribute()</code>方法获取当前主题下给定属性ID对应的资源信息并赋值给定义好的typedValue。因为可能存在给定属性对应的资源信息获取不到而抛出的异常，所以建议try&amp;catch一下，捕获可能存在的异常情况</p>
<p><br></p>
<ul>
<li><p><code>Step-02  根据获取的TypedValue所包含的资源信息获取对应的资源</code></p>
<pre><code>Resources resources = getResources();
    try {
        int color = ResourcesCompat.getColor(resources, typedValue.resourceId, null); // 获取颜色值
        Drawable drawable = ResourcesCompat.getDrawable(resources, typedValue.resourceId, null); // 获取Drawable对象
        String string = resources.getString(typedValue.resourceId); // 获取字符串
    } catch (Exception e) {
        e.printStackTrace();
    }
</code></pre></li>
</ul>
<p>TypedValue最重要的一个属性就是<code>resourceId</code>，只要确定获取的typedValue不为null。我们就可以通过<code>typedValue.resourceId</code>获取资源的id，就好比知道了一个颜色资源的ID是<code>R.color.black</code>，让你去获取颜色值，知道一个Drawable资源的ID是<code>R.drawable.ic_luncher</code>，让你去获取Drawable对象，想想就简单（捂脸.jpg）。需要注意的是在获取对应资源的时候为避免资源获取失败抛出的异常，各种获取资源的方法还是建议用try&amp;catch包裹一下。关于资源获取，文末给出的Demo中有一个<code>MarioResourceHelper</code>的辅助类，该类对资源获取一块进行了一个小封装，用起来会更加方便。    </p>
<p>而接下来需要做的就是对特定的资源进行替换就好了。<br><br></p>
<h3 id="补充一点："><a href="#补充一点：" class="headerlink" title="补充一点："></a>补充一点：</h3><p>关于前文提到主题换肤缺点时，其中一点就是所有资源文件都需要放置在主APK文件中打包发布，也许不同的主题就会有多套图片资源，在Android有限内存的条件下，这是一种非常糟糕的情况。<br>而在前文我也提及，应对这种现象，我们开发能做的就是使用drawable着色的方式，尽量用一套图片资源实现多种主题。<strong>切记！  着色的图片要求纯色且背景透明的PNG，因为着色并不能区分色彩，而是对所有非透明区域统一着色上指定的颜色。</strong>着色细节不做赘述，线上<a href="http://www.cnblogs.com/helloandroid/p/4779061.html" target="_blank" rel="external">《Drawable着色的后向兼容》</a>一文阐述的比较详细了吧，感谢作者分享 ！！而我们要做的就是将需要的着色上去的颜色值定义在不同的主题下，不同主题获取对应的颜色值，并对特定的drawable进行着色即可。 而<code>MarioResourceHelper</code>辅助类也会对drawable的着色方法做相应的封装。</p>
<p><a href="https://github.com/WuLiFei/DayNightModeSwitch" target="_blank" rel="external">Github项目源码地址</a></p>
<p>最后附上前文两张动图的原版录制视频，观看效果更佳 ！！ </p>
<p><a href="http://bmob-cdn-9449.b0.upaiyun.com/2017/03/06/dc9bb13540d67a5780e886e6db90df49.mp4" target="_blank" rel="external">预览效果第一季-蓝光</a><br><a href="http://bmob-cdn-9449.b0.upaiyun.com/2017/03/06/50199b1940120f02802331c439981208.mp4" target="_blank" rel="external">预览效果第二季-蓝光</a></p>
<blockquote>
<p><strong>作者申明：</strong>如果文中有表述不当或阐述错误的地方，还望正在看文章的您可以帮忙指出，有疑惑也可以在评论区提问或者私信，期待您的意见和建议，欢迎关注交流，转载请注明出处 ！</p>
</blockquote>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/android/article/cj47s3bqa000m5cozazd1cicm.html" rel="next" title="用自定义View实现歌词显示控件下篇之自定义LyricView的实现">
                <i class="fa fa-chevron-left"></i> 用自定义View实现歌词显示控件下篇之自定义LyricView的实现
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="CoderMario" />
          <p class="site-author-name" itemprop="name">CoderMario</p>
           
              <p class="site-description motion-element" itemprop="description">一个关于码农小阿飞的博客平台，记录开发的点点滴滴.</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/codermario" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/6081421055/profile?topnav=1&wvr=6&is_all=1" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备相关的属性样式及主题："><span class="nav-number">2.</span> <span class="nav-text">准备相关的属性样式及主题：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#自定义attr属性："><span class="nav-number">2.1.</span> <span class="nav-text">自定义attr属性：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#自定义theme主题："><span class="nav-number">2.2.</span> <span class="nav-text">自定义theme主题：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#自定义resource资源："><span class="nav-number">2.3.</span> <span class="nav-text">自定义resource资源：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#自定义color："><span class="nav-number">2.3.1.</span> <span class="nav-text">自定义color：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#自定义drawable："><span class="nav-number">2.3.2.</span> <span class="nav-text">自定义drawable：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#自定义colorStateList："><span class="nav-number">2.3.3.</span> <span class="nav-text">自定义colorStateList：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#在不同的主题样式下为自定义属性赋值："><span class="nav-number">2.4.</span> <span class="nav-text">在不同的主题样式下为自定义属性赋值：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#在XML布局文件中使用自定义属性："><span class="nav-number">2.5.</span> <span class="nav-text">在XML布局文件中使用自定义属性：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获得当前主题自定义属性指定的资源："><span class="nav-number">3.</span> <span class="nav-text">获得当前主题自定义属性指定的资源：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#补充一点："><span class="nav-number">4.</span> <span class="nav-text">补充一点：</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-circle-o"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CoderMario</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("P6MqnNK9knrnpy7DxP1iNiR8-gzGzoHsz", "WCRIMRTA9kItgoI7rDlmNtiJ");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

  
     <!-- custom analytics part create by xiamo -->
<script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
<script>AV.initialize("P6MqnNK9knrnpy7DxP1iNiR8-gzGzoHsz", "WCRIMRTA9kItgoI7rDlmNtiJ");</script>
<script>
function showTime(Counter) {
	var query = new AV.Query(Counter);
	$(".leancloud_visitors").each(function() {
		var url = $(this).attr("id").trim();
		query.equalTo("url", url);
		query.find({
			success: function(results) {
				if (results.length == 0) {
					var content = $(document.getElementById(url)).text() + ': 0';
					$(document.getElementById(url)).text(content);
					return;
				}
				for (var i = 0; i < results.length; i++) {
					var object = results[i];
					var content = $(document.getElementById(url)).text() + ': ' + object.get('time');
					$(document.getElementById(url)).text(content);
				}
			},
			error: function(object, error) {
				console.log("Error: " + error.code + " " + error.message);
			}
		});
	});
}
function addCount(Counter) {
	var Counter = AV.Object.extend("Counter");
	url = $(".leancloud_visitors").attr('id').trim();
	title = $(".leancloud_visitors").attr('data-flag-title').trim();
	var query = new AV.Query(Counter);
	query.equalTo("url", url);
	query.find({
		success: function(results) {
			if (results.length > 0) {
				var counter = results[0];
				counter.fetchWhenSave(true);
				counter.increment("time");
				counter.save(null, {
					success: function(counter) {
						var content = $(document.getElementById(url)).text() + ': ' + counter.get('time');
						$(document.getElementById(url)).text(content);
					},
					error: function(counter, error) {
						console.log('Failed to save Visitor num, with error message: ' + error.message);
					}
				});
			} else {
				var newcounter = new Counter();
				newcounter.set("title", title);
				newcounter.set("url", url);
				newcounter.set("time", 1);
				newcounter.save(null, {
					success: function(newcounter) {
					    console.log("newcounter.get('time')="+newcounter.get('time'));
						var content = $(document.getElementById(url)).text() + ': ' + newcounter.get('time');
						$(document.getElementById(url)).text(content);
					},
					error: function(newcounter, error) {
						console.log('Failed to create');
					}
				});
			}
		},
		error: function(error) {
			console.log('Error:' + error.code + " " + error.message);
		}
	});
}
$(function() {
	var Counter = AV.Object.extend("Counter");
	if ($('.leancloud_visitors').length == 1) {
		addCount(Counter);
	} else if ($('.post-title-link').length > 1) {
		showTime(Counter);
	}
});
</script>
  
</body>
</html>
